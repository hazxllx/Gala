<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>AWS Vector Map</title>
    <link href="https://unpkg.com/maplibre-gl@3.0.0/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://unpkg.com/maplibre-gl@3.0.0/dist/maplibre-gl.js"></script>
    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        .maplibregl-ctrl-bottom-left { display: none; }

        /* --- STYLES FOR NEARBY PLACES --- */
        .place-marker {
            background-color: #FF0000;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            cursor: pointer;
            transition: transform 0.2s;
        }
        .place-marker:active { transform: scale(1.2); }

        .place-tag {
            position: absolute;
            top: -28px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            color: black;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            white-space: nowrap;
            pointer-events: none;
        }
        .place-tag::after {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 50%;
            transform: translateX(-50%);
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-top: 4px solid white;
        }
    </style>
</head>
<body>

<div id="map"></div>

<script>
    // --- CONFIGURATION ---
    const REGION = 'ap-southeast-1'; 
    const MAP_NAME = 'MyNavigationApp'; 
    
    // YOUR FIXED API KEY
    const API_KEY = 'v1.public.eyJqdGkiOiJmNjYzMGVlYi0xNzA2LTQxNDItYWQyYy1jYzMzNTc0NGM0ZmIifQg38P6cE6L4sb71GcGuteb40sqtqQlariMJDviQkWwltWUwfUEc8rSPmUo3vtOHGEL0U0z9vpQBeVbdNfZZ886jGXhNY9Kc6xdNykSCuqleZ2gVOgb6YxLay0F9wTr2d9Uzv5wawpQEfhucGX8y9trnEAm68wSvCorCGAFlPMOsW2MAzEEMMsKpFMZ6Cf3rTO_v-_YHLniGzuWRiID0tY_d2pJBo9egY6QeYFNI-srp2gMRlXoqzHxbBoCNVDSxwSMH7oEgAIvEso8-Cb3iQ-puWGftX8-kQ3uoEUkHXPiTlGksY72Hi9fkUkC20KeOvCX-RZ9RL2PIb_xjSEn89Ec.MzRjYzZmZGUtZmY3NC00NDZiLWJiMTktNTc4YjUxYTFlOGZi';

    // Markers
    let map;
    let startMarker = new maplibregl.Marker({ color: "#4CAF50" }); 
    let destMarker = new maplibregl.Marker({ color: "#F44336" });
    let placeMarkers = []; // For Nearby Places

    // --- 1. FETCH & PATCH STYLE ---
    const styleUrl = `https://maps.geo.${REGION}.amazonaws.com/maps/v0/maps/${MAP_NAME}/style-descriptor?key=${API_KEY}`;

    fetch(styleUrl)
        .then(response => {
            if (!response.ok) {
                console.error(`Map Load Error: HTTP ${response.status}`);
                throw new Error("HTTP " + response.status);
            }
            return response.text();
        })
        .then(styleText => {
            // FIX: Patch Esri style syntax error
            const fixedStyleText = styleText
                .replace(/" rgba/g, '"rgba')
                .replace(/" hsla/g, '"hsla');

            initializeMap(JSON.parse(fixedStyleText));
        })
        .catch(error => console.error("Map Init Error:", error));

    function initializeMap(styleJson) {
        map = new maplibregl.Map({
            container: 'map',
            style: styleJson, 
            center: [123.1948, 13.6218], // Naga City
            zoom: 15,
            attributionControl: false,
            
            // --- RENDERING OPTIMIZATIONS ---
            pitchWithRotate: false, 
            dragRotate: false,      
            antialias: false,       
            fadeDuration: 0,        
            pixelRatio: Math.min(window.devicePixelRatio, 2) 
        });

        map.on('load', function () {
            addRouteLayer();
        });
    }

    // Helper to add the route layer
    function addRouteLayer() {
        if (!map.getSource('route')) {
            map.addSource('route', {
                'type': 'geojson',
                'data': {
                    'type': 'Feature',
                    'properties': {},
                    'geometry': { 'type': 'LineString', 'coordinates': [] }
                }
            });

            map.addLayer({
                'id': 'route',
                'type': 'line',
                'source': 'route',
                'layout': { 'line-join': 'round', 'line-cap': 'round' },
                'paint': { 'line-color': '#3B82F6', 'line-width': 6, 'line-opacity': 0.8 }
            });
        }
    }

    // --- DART FUNCTIONS ---

    // 1. Update Start/User Location
    function updateStartLocation(lat, lng) {
        if (!map) return;
        
        // Handle "hide" case (0,0)
        if(lat === 0 && lng === 0) {
            startMarker.remove();
            return;
        }

        startMarker.setLngLat([lng, lat]).addTo(map);
        
        // Only fly to location if we aren't currently viewing a route (dest is hidden)
        // or if we are just setting up
        if (!destMarker.getElement().parentElement) {
            map.flyTo({ center: [lng, lat], zoom: 15 });
        }
    }

    // 2. Update Destination
    function updateDestination(lat, lng) {
        if (!map) return;
        
        if(lat === 0 && lng === 0) {
            destMarker.remove();
            return;
        }
        
        destMarker.setLngLat([lng, lat]).addTo(map);
    }

    // 3. Draw Route (Robust Version)
    function drawRoute(coordinates) {
        if (!map) return;

        // Ensure layer exists before setting data
        if (!map.getSource('route')) {
            if (map.isStyleLoaded()) {
                addRouteLayer();
            } else {
                // If map isn't ready, wait for load event then draw
                map.once('load', () => drawRoute(coordinates));
                return;
            }
        }

        const geojson = {
            'type': 'Feature',
            'properties': {},
            'geometry': { 'type': 'LineString', 'coordinates': coordinates }
        };
        
        map.getSource('route').setData(geojson);

        if (coordinates.length > 0) {
            const bounds = coordinates.reduce(function (bounds, coord) {
                return bounds.extend(coord);
            }, new maplibregl.LngLatBounds(coordinates[0], coordinates[0]));

            map.fitBounds(bounds, { padding: 50 });
        }
    }

    // 4. Clear Route
    function clearRoute() {
        if (!map) return;
        destMarker.remove();
        if (map.getSource('route')) {
            map.getSource('route').setData({
                'type': 'Feature',
                'properties': {},
                'geometry': { 'type': 'LineString', 'coordinates': [] }
            });
        }
    }

    // 5. Update Nearby Places (For Nearby Mode)
    function updatePlaces(placesJson) {
        if (!map) return;

        // Clear existing place markers
        placeMarkers.forEach(m => m.remove());
        placeMarkers = [];

        // Clear routing visualization to avoid clutter
        clearRoute();

        const places = JSON.parse(placesJson);

        places.forEach(place => {
            // DOM Element for Marker
            const el = document.createElement('div');
            el.className = 'place-marker';

            // Label Tag
            const tag = document.createElement('div');
            tag.className = 'place-tag';
            tag.innerText = place.label.split(',')[0];
            el.appendChild(tag);

            // Interaction
            el.addEventListener('click', () => {
               if(window.PlaceSelected) {
                   window.PlaceSelected.postMessage(JSON.stringify(place));
               }
            });

            const marker = new maplibregl.Marker({ element: el })
                .setLngLat([place.lon, place.lat])
                .addTo(map);
            
            placeMarkers.push(marker);
        });
    }
</script>

</body>
</html>